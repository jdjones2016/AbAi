<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AbAI — Antibody Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PDFMAKE (client-side PDFs, free) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/vfs_fonts.js"></script>
  <style>
    .card { @apply rounded-2xl border border-gray-200 bg-white p-4 shadow; }
    .btn  { @apply inline-flex items-center gap-2 rounded-xl border px-3 py-2 text-sm shadow hover:shadow-md transition; }
    .btn-primary { @apply bg-black text-white border-black; }
    .badge { @apply inline-flex items-center rounded-full bg-gray-100 px-2 py-1 text-xs font-medium text-gray-700; }
    .input { @apply w-full rounded-xl border border-gray-300 px-3 py-2; }
    .tab-active { @apply bg-black text-white; }
    .dark .card { @apply bg-zinc-900 border-zinc-800; }
    .dark .btn { @apply border-zinc-700; }
    .dark body { @apply bg-zinc-950 text-zinc-50; }
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900">
  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Top bar -->
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <span class="text-2xl">🤖</span>
        <h1 class="text-2xl font-bold">AbAI — Antibody Assistant</h1>
        <span class="text-xs opacity-70 border px-2 py-1 rounded-full">MVP</span>
      </div>
      <button id="mode" class="btn">🌙 Dark mode</button>
    </div>

    <!-- Tabs -->
    <div class="mt-6 inline-flex overflow-hidden rounded-2xl border bg-white dark:bg-zinc-900 dark:border-zinc-800">
      <button data-tab="chat" class="px-4 py-2 text-sm tab-active">Design Assistant</button>
      <button data-tab="experiments" class="px-4 py-2 text-sm">My Experiments</button>
      <button data-tab="inventory" class="px-4 py-2 text-sm">Inventory</button>
    </div>

    <!-- CHAT -->
    <section id="chat" class="grid md:grid-cols-[1fr_360px] gap-6 mt-6">
      <!-- Messages -->
      <div class="card">
        <div id="msgs" class="h-[64vh] overflow-auto space-y-4 pr-1">
          <!-- assistant greeting will render here -->
        </div>

        <!-- Composer -->
        <div class="border-t mt-3 pt-3">
          <div class="flex items-center gap-2">
            <label class="btn cursor-pointer">
              📎 Attach images
              <input id="files" type="file" accept="image/*" multiple class="hidden">
            </label>
            <input id="input" class="input flex-1" placeholder="Type your message… (Enter to send)">
            <button id="send" class="btn btn-primary">Send</button>
          </div>
          <div id="attached" class="flex gap-2 mt-2 flex-wrap text-xs"></div>
          <div class="flex gap-2 mt-2">
            <button id="extractEq" class="btn">🔍 Extract equipment from images</button>
            <button id="searchNow" class="btn">🌐 Search now</button>
            <button id="runBlast" class="btn">🧬 Run BLAST</button>
            <button id="genPdf" class="btn btn-primary">📄 Generate PDF & Save</button>
          </div>
        </div>
      </div>

      <!-- Right panel: summary -->
      <div class="space-y-4">
        <div class="card">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Design Summary</h3>
            <span id="protoReady" class="text-xs opacity-70">protocol: not ready</span>
          </div>
          <div id="summary" class="mt-3 text-sm space-y-1"></div>
          <div class="mt-3">
            <h4 class="font-semibold mb-1">Antibody Panel</h4>
            <div id="panel" class="text-sm space-y-2"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- EXPERIMENTS -->
    <section id="experiments" class="hidden mt-6">
      <div class="card">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">My Experiments</h3>
        </div>
        <div id="expList" class="mt-3 grid gap-3"></div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="inventory" class="hidden mt-6 space-y-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <h3 class="font-semibold">Inventory</h3>
          <span id="invCount" class="text-xs opacity-70">0 items</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="addItem" class="btn">➕ Add item</button>
          <button id="delSelected" class="btn">🗑️ Delete selected</button>
          <button id="dlCsv" class="btn btn-primary">⬇️ Download CSV</button>
          <button id="dlInvPdf" class="btn btn-primary">📄 Inventory PDF</button>
        </div>
      </div>

      <div class="overflow-auto card p-0">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="border-b">
              <th class="p-3"><input id="chkAll" type="checkbox"></th>
              <th class="p-3">Item</th>
              <th class="p-3">Description</th>
              <th class="p-3">Link</th>
              <th class="p-3">Qty</th>
              <th class="p-3">Date Added</th>
              <th class="p-3">Expiration</th>
            </tr>
          </thead>
          <tbody id="invBody"></tbody>
        </table>
      </div>
      <div class="text-xs opacity-70">* Expiration will be checked during planning; expired items are excluded unless overridden.</div>
    </section>
  </main>

  <script>
    // ================== CONFIG (optional) ==================
    // If you set an ABAI_TOKEN in Cloudflare Pages (Settings → Environment Variables),
    // put the same value here to send it with every request.
    // Leave as null if you didn't set a token.
    const CLIENT_ABAI_TOKEN = null; // e.g., "my-shared-secret"

    // Helper to add common headers (and optional token)
    function withHeaders(base = {}, isMultipart = false) {
      const h = new Headers(base);
      if (!isMultipart && !h.has('content-type')) h.set('content-type', 'application/json');
      if (CLIENT_ABAI_TOKEN) h.set('x-abai-token', CLIENT_ABAI_TOKEN);
      return h;
    }

    // ================== PDF HELPERS (client-side) ==================
    function money(n) { return n == null ? '—' : `$${Number(n).toFixed(2)}`; }

    function docForExperiment(exp) {
      const { title, summary, inputsTable, bomTable, blastResults, protocolHtml } = exp;

      function tableFrom(rows) {
        if (!rows || !rows.length) return { text: '—', margin: [0,4,0,0] };
        const header = rows[0].map(h => ({ text: String(h), style: 'th' }));
        const body = [header, ...rows.slice(1).map(r => r.map(c => ({ text: String(c ?? '') })))];
        return {
          table: { headerRows: 1, widths: Array(header.length).fill('*'), body },
          layout: 'lightHorizontalLines',
          margin: [0, 6, 0, 12]
        };
      }

      function stripHtml(html) {
        const div = document.createElement('div'); div.innerHTML = html || '';
        return div.textContent || div.innerText || '';
      }

      return {
        pageSize: 'A4',
        pageMargins: [36, 48, 36, 54],
        footer: (current, total) => ({
          columns: [
            { text: 'AbAI — Antibody Assistant', style: 'footerLeft' },
            { text: `Page ${current} of ${total}`, alignment: 'right', style: 'footerRight' }
          ],
          margin: [36, 6, 36, 12]
        }),
        content: [
          { text: title || 'Staining Experiment', style: 'h1' },
          { text: summary || '', style: 'summary' },
          { text: 'Inputs', style: 'h2', margin: [0, 16, 0, 4] },
          tableFrom(inputsTable),
          ...(blastResults ? [
            { text: 'BLAST Results', style: 'h2', margin: [0, 8, 0, 4] },
            { text: JSON.stringify(blastResults, null, 2), style: 'code' }
          ] : []),
          { text: 'Bill of Materials', style: 'h2', margin: [0, 8, 0, 4] },
          tableFrom(bomTable),
          { text: 'Protocol', style: 'h2', margin: [0, 8, 0, 4], pageBreak: 'before' },
          { text: stripHtml(protocolHtml), style: 'body' }
        ],
        styles: {
          h1: { fontSize: 20, bold: true, margin: [0, 0, 0, 8] },
          h2: { fontSize: 14, bold: true },
          summary: { margin: [0, 4, 0, 8] },
          th: { bold: true, fillColor: '#efefef' },
          code: { fontSize: 9, color: '#333', margin: [0, 2, 0, 8] },
          body: { fontSize: 11 },
          footerLeft: { fontSize: 9, color: '#666' },
          footerRight: { fontSize: 9, color: '#666' }
        },
        defaultStyle: { fontSize: 11 }
      };
    }

    function docForInventory(inv) {
      const rows = [
        ['Name','Description','Link','Qty','Date Added','Expiration'],
        ...inv.map(i => [
          i.name || '', i.description || '', i.link || '', String(i.qty || 0),
          (i.dateAdded || '').slice(0,10), (i.expiration || '').slice(0,10)
        ])
      ];
      return {
        pageSize: 'A4',
        pageMargins: [36, 48, 36, 54],
        content: [
          { text: 'Inventory', style: 'h1' },
          {
            table: {
              headerRows: 1,
              widths: ['*','*','*','auto','auto','auto'],
              body: [
                rows[0].map(h => ({ text: h, style: 'th' })),
                ...rows.slice(1).map(r => r.map(c => ({ text: String(c ?? '') })))
              ]
            },
            layout: 'lightHorizontalLines'
          }
        ],
        styles: {
          h1: { fontSize: 20, bold: true, margin: [0, 0, 0, 12] },
          th: { bold: true, fillColor: '#efefef' }
        },
        defaultStyle: { fontSize: 11 }
      };
    }

    // ================== State / Elements ==================
    const el = (id) => document.getElementById(id);
    const msgsEl = el('msgs');
    const inputEl = el('input');
    const filesEl = el('files');
    const attachedEl = el('attached');
    const protoReadyEl = el('protoReady');
    const summaryEl = el('summary');
    const panelEl = el('panel');
    const expListEl = el('expList');
    const invBodyEl = el('invBody');
    const invCountEl = el('invCount');
    const chkAllEl = el('chkAll');

    let dark = false;
    let uploads = []; // {name, file}
    let messages = [{ role:'assistant', content: "Hi! I’m AbAI. Tell me your staining goal (e.g., ‘Assess skeletal muscle differentiation in primary satellite cells’). I’ll gather details, search protocols/antibodies, and generate a protocol + shopping PDF." }];
    let design = {};     // filled step-by-step
    let inventory = [];  // fetched from API
    let experiments = []; // fetched from API

    // ================== Tabs ==================
    const tabs = document.querySelectorAll('[data-tab]');
    const sections = { chat: el('chat'), experiments: el('experiments'), inventory: el('inventory') };
    tabs.forEach(b=>{
      b.onclick = () => {
        tabs.forEach(x=>x.classList.remove('tab-active'));
        b.classList.add('tab-active');
        Object.values(sections).forEach(s=>s.classList.add('hidden'));
        sections[b.dataset.tab].classList.remove('hidden');
        if (b.dataset.tab==='experiments') loadExperiments();
        if (b.dataset.tab==='inventory') loadInventory();
      };
    });

    // ================== Dark mode ==================
    el('mode').onclick = () => {
      dark = !dark;
      document.documentElement.classList.toggle('dark', dark);
      el('mode').textContent = dark ? "☀️ Light mode" : "🌙 Dark mode";
    };

    // ================== Render Helpers ==================
    function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function renderMsgs() {
      msgsEl.innerHTML = '';
      messages.forEach(m => {
        const bubble = document.createElement('div');
        bubble.className = 'max-w-[80%] rounded-2xl px-4 py-3 text-sm leading-relaxed shadow ' + (m.role==='assistant' ? 'bg-neutral-100 dark:bg-zinc-800' : 'bg-black text-white dark:bg-zinc-100 dark:text-zinc-900 ml-auto');
        bubble.innerHTML = '<div class="opacity-70 text-xs mb-1">' + (m.role==='assistant' ? 'AbAI' : 'You') + '</div>' + escapeHtml(m.content);
        msgsEl.appendChild(bubble);
      });
      msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    function renderSummary() {
      const d = design || {};
      summaryEl.innerHTML = [
        row('Goal', d.goal||'—'),
        row('Species', d.species||'—'),
        row('Target', d.target||'—'),
        row('Equipment', (d.availableEquipment||[]).join(', ')||'—'),
        row('Budget', d?.constraints?.budgetUSD != null ? ('$'+d.constraints.budgetUSD) : '—'),
        row('Time limit', d?.constraints?.timeLimitHours != null ? (d.constraints.timeLimitHours+' h') : '—'),
        row('BLAST required', d.blastRequired ? 'Yes' : 'No')
      ].join('');
      protoReadyEl.textContent = 'protocol: ' + (d.protocolReady ? 'ready' : 'not ready');

      // Panel
      panelEl.innerHTML = '';
      (d.selectedAntibodies||[]).forEach(a => {
        const div = document.createElement('div');
        div.className = 'border rounded-xl p-2 flex items-center justify-between';
        div.innerHTML = '<div><div class="font-medium">'+escapeHtml(a.name)+'</div><div class="text-xs opacity-70">'+(a.isPrimary?'Primary':'Secondary')+' • '+(a.vendor||'—')+(a.conjugate?(' • '+a.conjugate):'')+'</div></div><div class="text-xs opacity-70">'+(a.reactivity||[]).join('/')+'</div>';
        panelEl.appendChild(div);
      });
      if (!d.selectedAntibodies || d.selectedAntibodies.length===0){
        panelEl.innerHTML = '<div class="text-xs opacity-70">No antibodies selected yet.</div>';
      }

      function row(k,v){ return '<div class="flex items-start justify-between gap-4"><div class="opacity-70">'+k+'</div><div class="text-right font-medium max-w-[60%]">'+escapeHtml(String(v))+'</div></div>'; }
    }

    function renderUploads() {
      attachedEl.innerHTML = uploads.map(u => '<span class="badge">'+escapeHtml(u.name)+'</span>').join(' ');
    }

    // ================== Greeting ==================
    renderMsgs(); renderSummary();

    // ================== Chat send ==================
    el('send').onclick = send;
    inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ send(); }});
    filesEl.onchange = () => {
      uploads = uploads.concat(Array.from(filesEl.files || []).map(f => ({ name: f.name, file: f })));
      renderUploads();
    };

    async function send() {
      const text = inputEl.value.trim();
      if (!text && uploads.length===0) return;

      // Add user message
      messages.push({ role:'user', content: text });
      renderMsgs();
      inputEl.value = '';

      try {
        const res = await fetch('/api/llm/plan-step', {
          method: 'POST',
          headers: withHeaders(),
          body: JSON.stringify({ messages, design, inventory })
        });
        const json = await res.json();
        if (json.facts_patch) design = { ...design, ...json.facts_patch };
        messages.push({ role:'assistant', content: json.assistant_message || '(no response)' });
      } catch (e) {
        messages.push({ role:'assistant', content: 'Sorry, I hit a network error calling /api/llm/plan-step.' });
      }
      renderMsgs(); renderSummary();
    }

    // ================== Buttons ==================
    el('extractEq').onclick = async () => {
      if (uploads.length===0) { alert('Attach at least one image first.'); return; }
      const fd = new FormData();
      uploads.forEach(u => u.file && fd.append('file', u.file, u.name));
      const r = await fetch('/api/equipment/ocr', { method: 'POST', headers: withHeaders({}, true), body: fd });
      const eq = await r.json();
      if (eq.equipment?.length){
        const set = new Set([...(design.availableEquipment||[]), ...eq.equipment]);
        design.availableEquipment = Array.from(set);
        renderSummary();
        messages.push({ role:'assistant', content: 'I detected equipment: ' + design.availableEquipment.join(', ') });
        renderMsgs();
      }
    };

    el('searchNow').onclick = async () => {
      const r = await fetch('/api/search', {
        method:'POST', headers: withHeaders(),
        body: JSON.stringify({ goal: design.goal, species: design.species, target: design.target, constraints: design.constraints })
      });
      const data = await r.json();
      design.selectedAntibodies = data.antibodies || [];
      design.protocolReady = true;
      messages.push({ role:'assistant', content: 'I found protocols and candidate antibodies. Protocol is ready to assemble.' });
      renderMsgs(); renderSummary();
    };

    el('runBlast').onclick = async () => {
      const r = await fetch('/api/epitope/blast', {
        method:'POST', headers: withHeaders(),
        body: JSON.stringify({ target: design.target, species: design.species })
      });
      const b = await r.json();
      design.blastResult = b;
      messages.push({ role:'assistant', content: `BLAST result: best hit ${b.bestHitTarget}, identity ${b.identityPct}%` });
      renderMsgs(); renderSummary();
    };

    // ---- UPDATED: Client-side PDF for Experiment ----
    el('genPdf').onclick = async () => {
      // 1) Build shopping list
      const bomRes = await fetch('/api/shop/build-list', {
        method:'POST', headers: withHeaders(),
        body: JSON.stringify({ design, inventory })
      });
      const bom = await bomRes.json();

      // 2) Build tables for export
      const inputsTable = [
        ['Goal', design.goal||'—'],
        ['Species', design.species||'—'],
        ['Target', design.target||'—'],
        ['Equipment', (design.availableEquipment||[]).join(', ')||'—'],
        ['Budget (USD)', design?.constraints?.budgetUSD ?? '—'],
        ['Time limit (h)', design?.constraints?.timeLimitHours ?? '—']
      ];
      const bomTable = [
        ['Image','Name','Description','Link','Unit Cost','Qty','Total'],
        ...((bom.items||[]).map(it => [
          '', // omit image in PDF (CORS); can be added later as data URL
          it.name, it.description, it.link, money(it.unitCost), it.units, money(it.total)
        ])),
        ['','','','','','Grand Total', money(bom.grandTotal||0)]
      ];

      const experiment = {
        title: (design.goal || 'Staining Experiment').slice(0,80),
        summary: `Species: ${design.species||'—'} | Target: ${design.target||'—'} | Budget: ${design?.constraints?.budgetUSD ?? '—'} | Time: ${design?.constraints?.timeLimitHours ?? '—'}h`,
        inputsTable,
        blastResults: design.blastResult || null,
        bomTable,
        protocolHtml: "<h3>Fixation</h3><p>4% PFA 10–15 min...</p><h3>Permeabilization</h3><p>0.1% Triton X-100 10 min...</p><h3>Blocking</h3><p>1–5% BSA 30–60 min...</p><h3>Primary</h3><p>Overnight 4°C or 1–2 h RT...</p><h3>Secondary</h3><p>1 h RT, protected from light...</p><h3>Imaging</h3><p>Match channels to conjugates; avoid bleed-through...</p>"
      };

      // 3) Build PDF (client-side) and save the data URL
      const doc = docForExperiment(experiment);
      pdfMake.createPdf(doc).getDataUrl(async (dataUrl) => {
        await fetch('/api/experiments', {
          method:'POST', headers: withHeaders(),
          body: JSON.stringify({ title: experiment.title, summary: experiment.summary, pdfUrl: dataUrl, designSnapshot: design })
        });
        messages.push({ role:'assistant', content: 'Your experiment was saved with a real PDF. See “My Experiments” to download or remix.' });
        renderMsgs();
      });
    };

    // ================== Experiments ==================
    async function loadExperiments(){
      const r = await fetch('/api/experiments', { headers: withHeaders() });
      experiments = await r.json();
      expListEl.innerHTML = '';
      experiments.forEach(exp => {
        const div = document.createElement('div');
        div.className = 'border rounded-2xl p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3';
        div.innerHTML = `
          <div>
            <div class="font-medium">${escapeHtml(exp.title||'Experiment')}</div>
            <div class="text-xs opacity-70">${new Date(exp.date||Date.now()).toLocaleString()}</div>
            <div class="text-sm mt-1">${escapeHtml(exp.summary||'')}</div>
          </div>
          <div class="flex items-center gap-2">
            <a class="btn btn-primary" href="${exp.pdfUrl}">⬇️ Download</a>
            <button class="btn">🔁 Remix</button>
          </div>
        `;
        div.querySelector('button').onclick = () => {
          // Load snapshot to design and switch back to chat
          design = exp.designSnapshot || {};
          tabs.forEach(x=>x.classList.remove('tab-active'));
          document.querySelector('[data-tab="chat"]').classList.add('tab-active');
          Object.values(sections).forEach(s=>s.classList.add('hidden'));
          sections.chat.classList.remove('hidden');
          renderSummary();
          messages.push({ role:'assistant', content: 'Loaded previous design. What would you like to modify?' });
          renderMsgs();
        };
        expListEl.appendChild(div);
      });
      if (experiments.length===0) expListEl.innerHTML = '<div class="text-sm opacity-70">No experiments yet.</div>';
    }

    // ================== Inventory ==================
    async function loadInventory(){
      const r = await fetch('/api/inventory', { headers: withHeaders() });
      inventory = await r.json();
      renderInventory();
    }

    function renderInventory(){
      invBodyEl.innerHTML = '';
      invCountEl.textContent = inventory.length + ' items';
      inventory.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-0';
        tr.innerHTML = `
          <td class="p-3 align-top"><input type="checkbox" data-id="${item.id}"></td>
          <td class="p-3 align-top">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-xl bg-neutral-200 dark:bg-zinc-800 flex items-center justify-center overflow-hidden">
                ${item.image ? `<img src="${item.image}" class="w-full h-full object-cover"/>` : '🧪'}
              </div>
              <div><input class="border rounded px-2 py-1" value="${escapeHtml(item.name||'')}" data-f="name" data-id="${item.id}"></div>
            </div>
          </td>
          <td class="p-3 align-top w-[30%]"><textarea class="w-full border rounded px-2 py-1" data-f="description" data-id="${item.id}">${escapeHtml(item.description||'')}</textarea></td>
          <td class="p-3 align-top"><input class="w-full border rounded px-2 py-1" data-f="link" data-id="${item.id}" value="${escapeHtml(item.link||'')}"></td>
          <td class="p-3 align-top"><input type="number" min="0" class="w-20 border rounded px-2 py-1" data-f="qty" data-id="${item.id}" value="${item.qty||0}"></td>
          <td class="p-3 align-top"><input type="date" class="border rounded px-2 py-1" data-f="dateAdded" data-id="${item.id}" value="${(item.dateAdded||'').slice(0,10)}"></td>
          <td class="p-3 align-top"><input type="date" class="border rounded px-2 py-1" data-f="expiration" data-id="${item.id}" value="${(item.expiration||'').slice(0,10)}"></td>
        `;
        invBodyEl.appendChild(tr);
      });
    }

    // Add item
    el('addItem').onclick = async () => {
      const r = await fetch('/api/inventory', { method:'POST', headers: withHeaders(),
        body: JSON.stringify({ name:'New item', qty:1, dateAdded: new Date().toISOString() })
      });
      const rec = await r.json();
      inventory.unshift(rec); renderInventory();
    };

    // Update fields
    invBodyEl.addEventListener('change', async (e)=>{
      const t = e.target;
      const id = t.getAttribute('data-id'); const f = t.getAttribute('data-f'); if (!id||!f) return;
      const val = (f==='qty') ? Number(t.value) : t.value;
      await fetch('/api/inventory', { method:'PATCH', headers: withHeaders(),
        body: JSON.stringify({ id, [f]: val })
      });
    });

    // Select all
    chkAllEl.onchange = () => {
      invBodyEl.querySelectorAll('input[type="checkbox"][data-id]').forEach(cb => cb.checked = chkAllEl.checked);
    };

    // Delete selected
    el('delSelected').onclick = async () => {
      const ids = Array.from(invBodyEl.querySelectorAll('input[type="checkbox"][data-id]:checked')).map(cb => cb.getAttribute('data-id'));
      if (ids.length===0) return;
      await fetch('/api/inventory', { method:'PATCH', headers: withHeaders(), body: JSON.stringify({ delete:true, ids }) });
      inventory = inventory.filter(i => !ids.includes(i.id)); renderInventory();
    };

    // CSV download
    el('dlCsv').onclick = () => {
      const headers = ["Name","Description","Link","Qty","Date Added","Expiration"];
      const rows = inventory.map(i => [i.name||'', i.description||'', i.link||'', String(i.qty||0), i.dateAdded||'', i.expiration||'']);
      const csv = [headers.join(','), ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n');
      const url = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
      const a = document.createElement('a'); a.href=url; a.download='inventory.csv'; a.click(); URL.revokeObjectURL(url);
    };

    // ---- UPDATED: Client-side PDF for Inventory ----
    el('dlInvPdf').onclick = async () => {
      const doc = docForInventory(inventory);
      // open in new tab (or use .download('inventory.pdf') to force download)
      pdfMake.createPdf(doc).open();
    };

    // ================== Init ==================
    (async function init(){
      renderMsgs();
      try { await loadInventory(); } catch { /* ignore */ }
      try { await loadExperiments(); } catch { /* ignore */ }
    })();
  </script>
</body>
</html>
